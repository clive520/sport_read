<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的全方位運動紀錄</title>
    <!-- Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js (圖表庫) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .loading-spinner { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 隱藏滾動條但保持功能 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Tab 動畫與樣式 */
        .tab-btn.active { background-color: white; color: #2563eb; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .tab-btn { color: #4b5563; }
        .tab-btn:hover:not(.active) { color: #111827; }
    </style>
</head>
<body class="text-gray-800">

    <!-- 導航列 -->
    <nav class="bg-white shadow-md fixed w-full z-10 top-0">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-heart-pulse text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-gray-900 hidden sm:block">運動儀表板</h1>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button onclick="openHelp()" class="p-2 text-gray-500 hover:text-blue-600 transition" title="使用說明">
                        <i class="fa-solid fa-circle-info text-xl"></i>
                    </button>
                    <button onclick="openSettings()" class="p-2 text-gray-500 hover:text-blue-600 transition" title="設定">
                        <i class="fa-solid fa-gear text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-10">

        <!-- 狀態與載入提示 -->
        <div id="statusMsg" class="hidden mb-4 p-4 rounded-md text-sm font-medium"></div>

        <!-- 頁籤切換 (Tabs) -->
        <div class="flex justify-center mb-6">
            <div class="flex space-x-1 bg-gray-200 p-1 rounded-lg">
                <button onclick="switchMainTab('dashboard')" id="nav-dashboard" class="tab-btn active px-4 sm:px-8 py-2 rounded-md text-sm font-medium transition-all">
                    <i class="fa-solid fa-chart-line mr-2"></i>綜合分析
                </button>
                <button onclick="switchMainTab('running')" id="nav-running" class="tab-btn px-4 sm:px-8 py-2 rounded-md text-sm font-medium transition-all">
                    <i class="fa-solid fa-person-running mr-2"></i>跑步明細
                </button>
                <button onclick="switchMainTab('cycling')" id="nav-cycling" class="tab-btn px-4 sm:px-8 py-2 rounded-md text-sm font-medium transition-all">
                    <i class="fa-solid fa-bicycle mr-2"></i>單車明細
                </button>
            </div>
        </div>

        <!-- 載入動畫 (全域) -->
        <div id="globalLoader" class="hidden flex flex-col justify-center items-center py-20">
            <div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-blue-500 h-10 w-10 mb-4"></div>
            <span class="text-gray-500 font-medium">正在整合所有數據...</span>
        </div>

        <!-- ==================== 頁面 1: 綜合分析儀表板 (Dashboard) ==================== -->
        <div id="view-dashboard" class="space-y-6 animate-fade-in">
            
            <!-- 統計卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
                    <p class="text-gray-500 text-sm font-medium mb-1">總累積距離</p>
                    <h3 class="text-3xl font-bold text-gray-800"><span id="dashTotalDistance">0.0</span> <span class="text-lg text-gray-400 font-normal">km</span></h3>
                    <div class="mt-2 text-xs text-gray-400 flex items-center">
                        <span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-1"></span> 跑步 <span id="dashRunDist" class="mr-2 text-gray-600">0</span>
                        <span class="inline-block w-2 h-2 bg-emerald-500 rounded-full mr-1"></span> 單車 <span id="dashBikeDist" class="text-gray-600">0</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-orange-500"></div>
                    <p class="text-gray-500 text-sm font-medium mb-1">總消耗熱量</p>
                    <h3 class="text-3xl font-bold text-gray-800"><span id="dashTotalCalories">0</span> <span class="text-lg text-gray-400 font-normal">kcal</span></h3>
                    <div class="mt-2 text-xs text-gray-400">燃燒脂肪的最佳證明</div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-purple-500"></div>
                    <p class="text-gray-500 text-sm font-medium mb-1">總運動次數</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="dashTotalCount">0</h3>
                    <div class="mt-2 text-xs text-gray-400">持續累積中</div>
                </div>
            </div>

            <!-- 圖表控制區 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fa-solid fa-chart-simple text-blue-500 mr-2"></i>運動趨勢分析
                    </h2>
                    <!-- 時間粒度切換 -->
                    <div class="flex bg-gray-100 rounded-lg p-1 text-xs sm:text-sm">
                        <button onclick="updateChartPeriod('day')" id="btn-period-day" class="period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900">日</button>
                        <button onclick="updateChartPeriod('week')" id="btn-period-week" class="period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900">週</button>
                        <button onclick="updateChartPeriod('month')" id="btn-period-month" class="period-btn px-3 py-1.5 rounded-md transition-all bg-white shadow-sm text-blue-600 font-bold">月</button>
                        <button onclick="updateChartPeriod('year')" id="btn-period-year" class="period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900">年</button>
                    </div>
                </div>
                
                <!-- Chart.js Canvas -->
                <div class="relative h-72 w-full">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- 綜合列表 (List View) -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">近期運動紀錄 (整合)</h3>
                    <span class="text-xs text-gray-400">依日期排序</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">距離 (km)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">熱量 (kcal)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            </tr>
                        </thead>
                        <tbody id="combinedTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 綜合資料 -->
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-3 border-t border-gray-100 bg-gray-50 text-center">
                    <button onclick="switchMainTab('running')" class="text-xs text-blue-500 hover:underline">查看更多明細...</button>
                </div>
            </div>
        </div>

        <!-- ==================== 頁面 2 & 3: 個別明細 (共用 Table 結構) ==================== -->
        <div id="view-detail" class="hidden space-y-4">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center" id="detailHeader">
                    <h3 class="font-bold text-gray-700">詳細紀錄</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期/時間</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">持續時間</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">距離 (km)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">熱量 (kcal)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">均速 (km/h)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 個別資料 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- 設定 Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4">系統設定</h3>
                        <div class="space-y-4">
                            <!-- GAS URL -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">GAS 部署網址</label>
                                <input type="password" id="settingGasUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 sm:text-sm p-2 border">
                            </div>
                            <!-- Running Settings -->
                            <div class="bg-blue-50 p-3 rounded-md">
                                <label class="block text-sm font-medium text-blue-700">跑步試算表 ID</label>
                                <input type="text" id="settingRunId" class="mt-1 block w-full rounded-md border-gray-300 sm:text-sm p-2 border">
                                <label class="block text-xs text-gray-500 mt-1">工作表名稱</label>
                                <input type="text" id="settingRunSheetName" class="mt-1 block w-full rounded-md border-gray-300 text-xs p-2 border" value="運動紀錄 ">
                            </div>
                            <!-- Cycling Settings -->
                            <div class="bg-emerald-50 p-3 rounded-md">
                                <label class="block text-sm font-medium text-emerald-700">腳踏車試算表 ID</label>
                                <input type="text" id="settingBikeId" class="mt-1 block w-full rounded-md border-gray-300 sm:text-sm p-2 border">
                                <label class="block text-xs text-gray-500 mt-1">工作表名稱</label>
                                <input type="text" id="settingBikeSheetName" class="mt-1 block w-full rounded-md border-gray-300 text-xs p-2 border" value="騎乘紀錄  ">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 justify-between">
                        <button type="button" onclick="saveSettings()" class="w-full sm:w-auto inline-flex justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 ml-3">儲存</button>
                        <button type="button" onclick="closeSettings()" class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 說明 Modal (保持簡化，邏輯同前) -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-80" onclick="closeHelp()"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 relative z-10">
            <h2 class="text-xl font-bold mb-4">使用說明</h2>
            <p class="text-sm text-gray-600 mb-4">本系統整合了您的「跑步」與「腳踏車」試算表。請確認您已正確部署 GAS 讀取專用腳本，並將 ID 填入設定中。</p>
            <div class="flex justify-end">
                <button onclick="closeHelp()" class="bg-gray-200 px-4 py-2 rounded text-sm hover:bg-gray-300">關閉</button>
            </div>
        </div>
    </div>

    <script>
        // === 全域變數 ===
        const LS_KEY = 'mySportTracker_config';
        let config = {};
        
        // 儲存原始資料 (Raw Data)
        let dataCache = {
            running: [],
            cycling: []
        };
        
        // Chart 實例
        let chartInstance = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            if (config.gasUrl) {
                initDashboard(); // 啟動並讀取所有資料
            } else {
                openSettings();
            }
        });

        // === 核心資料邏輯 ===

        // 初始化並同時抓取兩邊資料
        async function initDashboard() {
            const loader = document.getElementById('globalLoader');
            const dashboard = document.getElementById('view-dashboard');
            
            dashboard.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                // 平行運算：同時抓取跑步和單車資料
                const [runData, bikeData] = await Promise.all([
                    fetchRawData(config.runId, config.runSheet, 'running'),
                    fetchRawData(config.bikeId, config.bikeSheet, 'cycling')
                ]);

                dataCache.running = runData;
                dataCache.cycling = bikeData;

                // 預設顯示 Dashboard
                renderDashboard();
                
            } catch (error) {
                console.error("資料讀取失敗", error);
                document.getElementById('statusMsg').innerText = "資料讀取失敗，請檢查網路或設定";
                document.getElementById('statusMsg').classList.remove('hidden', 'bg-red-100', 'text-red-700');
            } finally {
                loader.classList.add('hidden');
                dashboard.classList.remove('hidden');
            }
        }

        // 單一 Fetch 封裝
        async function fetchRawData(id, sheet, type) {
            if (!id) return [];
            const url = `${config.gasUrl}?action=read&spreadsheetId=${id}&sheetName=${encodeURIComponent(sheet)}&type=${type}`;
            const res = await fetch(url);
            const json = await res.json();
            if (json.status !== 'success') throw new Error(json.message);
            // 加上 type 標記以便後續分辨
            return json.data.map(item => ({ ...item, type: type }));
        }

        // === 畫面渲染 ===

        function switchMainTab(tabName) {
            // 切換按鈕樣式
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                btn.classList.add('text-gray-600');
            });
            const activeBtn = document.getElementById(`nav-${tabName}`);
            activeBtn.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
            activeBtn.classList.remove('text-gray-600');

            // 切換視圖內容
            const viewDash = document.getElementById('view-dashboard');
            const viewDetail = document.getElementById('view-detail');

            if (tabName === 'dashboard') {
                viewDash.classList.remove('hidden');
                viewDetail.classList.add('hidden');
                // 確保圖表尺寸正確
                if(chartInstance) chartInstance.resize();
            } else {
                viewDash.classList.add('hidden');
                viewDetail.classList.remove('hidden');
                renderDetailTable(tabName);
            }
        }

        // 渲染 Dashboard 主畫面
        function renderDashboard() {
            const allData = [...dataCache.running, ...dataCache.cycling];
            
            // 1. 計算總計數據 (Total Stats)
            let totalDist = 0;
            let totalCal = 0;
            let runDist = 0;
            let bikeDist = 0;

            allData.forEach(d => {
                const dist = parseFloat(d.distance) || 0;
                const cal = parseFloat(d.calories) || 0;
                totalDist += dist;
                totalCal += cal;
                if(d.type === 'running') runDist += dist;
                if(d.type === 'cycling') bikeDist += dist;
            });

            animateValue("dashTotalDistance", 0, totalDist, 1000, true);
            animateValue("dashTotalCalories", 0, totalCal, 1000);
            animateValue("dashTotalCount", 0, allData.length, 1000);
            document.getElementById('dashRunDist').innerText = runDist.toFixed(1) + " km";
            document.getElementById('dashBikeDist').innerText = bikeDist.toFixed(1) + " km";

            // 2. 渲染近期綜合列表 (前 10 筆)
            const sortedData = allData.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            const combinedTbody = document.getElementById('combinedTableBody');
            combinedTbody.innerHTML = '';
            
            sortedData.forEach(row => {
                const icon = row.type === 'running' 
                    ? '<i class="fa-solid fa-person-running text-blue-500 text-lg"></i>' 
                    : '<i class="fa-solid fa-bicycle text-emerald-500 text-lg"></i>';
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-center w-16">${icon}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${row.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right font-mono">${parseFloat(row.distance).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right font-mono">${Math.round(row.calories)}</td>
                    <td class="px-6 py-4 text-sm text-gray-400 truncate max-w-xs">${row.notes}</td>
                `;
                combinedTbody.appendChild(tr);
            });

            // 3. 初始繪製圖表 (預設: 月)
            updateChartPeriod('month');
        }

        // 渲染個別詳細列表
        function renderDetailTable(type) {
            const tbody = document.getElementById('detailTableBody');
            const header = document.querySelector('#detailHeader h3');
            const data = dataCache[type];
            
            // 設定標題顏色與文字
            header.innerText = type === 'running' ? '跑步詳細紀錄' : '單車詳細紀錄';
            header.className = type === 'running' ? 'font-bold text-blue-700' : 'font-bold text-emerald-700';

            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">尚無資料</td></tr>`;
                return;
            }

            // 反轉顯示 (新到舊)
            [...data].reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${row.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.duration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-mono">${row.distance}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${row.calories}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${row.speed}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs" title="${row.notes}">${row.notes}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === 圖表與分析邏輯 ===
        
        // 切換圖表時間粒度
        function updateChartPeriod(period) {
            // UI 按鈕狀態
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.className = 'period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900';
            });
            const activeBtn = document.getElementById(`btn-period-${period}`);
            activeBtn.className = 'period-btn px-3 py-1.5 rounded-md transition-all bg-white shadow-sm text-blue-600 font-bold';

            processChartData(period);
        }

        // 處理圖表資料分組
        function processChartData(period) {
            const allData = [...dataCache.running, ...dataCache.cycling];
            const grouped = {}; // Key: DateLabel, Value: { running: 0, cycling: 0 }

            allData.forEach(item => {
                const dateObj = new Date(item.date); // 假設格式可被解析 (YYYY/MM/DD 或 YYYY-MM-DD)
                if (isNaN(dateObj)) return;

                let key = '';
                // 定義分組 Key
                if (period === 'day') {
                    // 為了避免過多，只取最近 14 天資料，或者顯示格式為 MM/DD
                    key = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
                } else if (period === 'week') {
                    // 簡單處理：顯示該週的週一日期
                    const d = new Date(dateObj);
                    const day = d.getDay() || 7;
                    if (day !== 1) d.setHours(-24 * (day - 1));
                    key = `${d.getMonth()+1}/${d.getDate()} 週`;
                } else if (period === 'month') {
                    key = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}`;
                } else if (period === 'year') {
                    key = `${dateObj.getFullYear()}`;
                }

                // 初始化
                if (!grouped[key]) grouped[key] = { running: 0, cycling: 0 };
                
                // 累加距離
                const dist = parseFloat(item.distance) || 0;
                if (item.type === 'running') grouped[key].running += dist;
                else grouped[key].cycling += dist;
            });

            // 排序 Key (日期)
            // 注意：這裡的排序邏輯比較簡單，若是複雜日期格式可能需要更嚴謹的 Date 比較
            const labels = Object.keys(grouped).sort(); 
            // 如果是 Day 模式，且資料量過大，可能要截取最後幾筆，這裡暫時全部顯示
            
            const dataRun = labels.map(k => grouped[k].running);
            const dataBike = labels.map(k => grouped[k].cycling);

            drawChart(labels, dataRun, dataBike);
        }

        function drawChart(labels, dataRun, dataBike) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '跑步 (km)',
                            data: dataRun,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // blue-500
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: '單車 (km)',
                            data: dataBike,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)', // emerald-500
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        // === 通用功能 (設定與動畫) ===
        function animateValue(id, start, end, duration, isFloat = false) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = progress * (end - start) + start;
                obj.innerHTML = isFloat ? val.toFixed(1) : Math.floor(val);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function loadSettings() {
            const saved = localStorage.getItem(LS_KEY);
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('settingGasUrl').value = config.gasUrl || '';
                document.getElementById('settingRunId').value = config.runId || '';
                document.getElementById('settingRunSheetName').value = config.runSheet || '運動紀錄 ';
                document.getElementById('settingBikeId').value = config.bikeId || '';
                document.getElementById('settingBikeSheetName').value = config.bikeSheet || '騎乘紀錄  ';
            }
        }

        function saveSettings() {
            config.gasUrl = document.getElementById('settingGasUrl').value.trim();
            config.runId = document.getElementById('settingRunId').value.trim();
            config.runSheet = document.getElementById('settingRunSheetName').value;
            config.bikeId = document.getElementById('settingBikeId').value.trim();
            config.bikeSheet = document.getElementById('settingBikeSheetName').value;
            
            localStorage.setItem(LS_KEY, JSON.stringify(config));
            closeSettings();
            initDashboard(); // 重新讀取
        }

        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
        function openHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }
    </script>
</body>
</html>
