<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的全方位運動紀錄</title>
    <!-- 解決 Favicon 404 錯誤 -->
    <link rel="icon" href="data:,">
    
    <!-- Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js (圖表庫) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .loading-spinner { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 隱藏滾動條但保持功能 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Tab 動畫與樣式 */
        .tab-btn.active { background-color: white; color: #2563eb; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .tab-btn { color: #4b5563; }
        .tab-btn:hover:not(.active) { color: #111827; }

        /* 月曆樣式 */
        .calendar-day { min-height: 80px; transition: all 0.2s; cursor: pointer; }
        .calendar-day:hover { background-color: #f3f4f6; }
        .calendar-day.empty { background-color: #f9fafb; cursor: default; }
        @media (max-width: 640px) { .calendar-day { min-height: 60px; } }
    </style>
</head>
<body class="text-gray-800">

    <!-- 導航列 -->
    <nav class="bg-white shadow-md fixed w-full z-10 top-0">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-heart-pulse text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-gray-900 hidden sm:block">運動儀表板</h1>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button onclick="openHelp()" class="p-2 text-gray-500 hover:text-blue-600 transition" title="使用說明">
                        <i class="fa-solid fa-circle-info text-xl"></i>
                    </button>
                    <button onclick="openSettings()" class="p-2 text-gray-500 hover:text-blue-600 transition" title="設定">
                        <i class="fa-solid fa-gear text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-10">

        <!-- 狀態與載入提示 -->
        <div id="statusMsg" class="hidden mb-4 p-4 rounded-md text-sm font-medium"></div>

        <!-- 頁籤切換 (Tabs) -->
        <div class="flex justify-center mb-6">
            <div class="flex space-x-1 bg-gray-200 p-1 rounded-lg">
                <button onclick="switchMainTab('dashboard')" id="nav-dashboard" class="tab-btn active px-4 sm:px-8 py-2 rounded-md text-sm font-medium transition-all">
                    <i class="fa-solid fa-calendar-days mr-2"></i>綜合與月曆
                </button>
                <button onclick="switchMainTab('running')" id="nav-running" class="tab-btn px-4 sm:px-8 py-2 rounded-md text-sm font-medium transition-all">
                    <i class="fa-solid fa-person-running mr-2"></i>跑步明細
                </button>
                <button onclick="switchMainTab('cycling')" id="nav-cycling" class="tab-btn px-4 sm:px-8 py-2 rounded-md text-sm font-medium transition-all">
                    <i class="fa-solid fa-bicycle mr-2"></i>單車明細
                </button>
            </div>
        </div>

        <!-- 載入動畫 (全域) -->
        <div id="globalLoader" class="hidden flex flex-col justify-center items-center py-20">
            <div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-blue-500 h-10 w-10 mb-4"></div>
            <span class="text-gray-500 font-medium">正在整合所有數據...</span>
        </div>

        <!-- ==================== 頁面 1: 綜合分析儀表板 (Dashboard) ==================== -->
        <div id="view-dashboard" class="space-y-6 animate-fade-in">
            
            <!-- 統計卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
                    <p class="text-gray-500 text-sm font-medium mb-1">總累積距離</p>
                    <h3 class="text-3xl font-bold text-gray-800"><span id="dashTotalDistance">0.0</span> <span class="text-lg text-gray-400 font-normal">km</span></h3>
                    <div class="mt-2 text-xs text-gray-400 flex items-center">
                        <span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-1"></span> 跑步 <span id="dashRunDist" class="mr-2 text-gray-600">0</span>
                        <span class="inline-block w-2 h-2 bg-emerald-500 rounded-full mr-1"></span> 單車 <span id="dashBikeDist" class="text-gray-600">0</span>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-orange-500"></div>
                    <p class="text-gray-500 text-sm font-medium mb-1">總消耗熱量</p>
                    <h3 class="text-3xl font-bold text-gray-800"><span id="dashTotalCalories">0</span> <span class="text-lg text-gray-400 font-normal">kcal</span></h3>
                    <div class="mt-2 text-xs text-gray-400">燃燒脂肪的最佳證明</div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1 bg-purple-500"></div>
                    <p class="text-gray-500 text-sm font-medium mb-1">總運動次數</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="dashTotalCount">0</h3>
                    <div class="mt-2 text-xs text-gray-400">持續累積中</div>
                </div>
            </div>

            <!-- 運動月曆區塊 (New!) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fa-regular fa-calendar-check text-blue-500 mr-2"></i>運動日記
                    </h2>
                    <div class="flex items-center space-x-4">
                        <button onclick="changeMonth(-1)" class="p-1 hover:text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="calendarTitle" class="text-lg font-semibold w-32 text-center">2023年 10月</span>
                        <button onclick="changeMonth(1)" class="p-1 hover:text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <!-- Calendar Grid -->
                <div class="w-full">
                    <!-- Weekday Headers -->
                    <div class="grid grid-cols-7 mb-2 text-center">
                        <div class="text-red-500 text-sm font-medium">日</div>
                        <div class="text-gray-500 text-sm font-medium">一</div>
                        <div class="text-gray-500 text-sm font-medium">二</div>
                        <div class="text-gray-500 text-sm font-medium">三</div>
                        <div class="text-gray-500 text-sm font-medium">四</div>
                        <div class="text-gray-500 text-sm font-medium">五</div>
                        <div class="text-blue-500 text-sm font-medium">六</div>
                    </div>
                    <!-- Days -->
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 border-t border-l border-gray-200 bg-gray-200">
                        <!-- JS Generated -->
                    </div>
                </div>
                <div class="mt-3 flex gap-4 text-xs text-gray-500 justify-end">
                    <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-1"></span> 跑步</div>
                    <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-emerald-500 mr-1"></span> 單車</div>
                </div>
            </div>

            <!-- 圖表控制區 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fa-solid fa-chart-simple text-blue-500 mr-2"></i>趨勢分析
                    </h2>
                    <!-- 時間粒度切換 -->
                    <div class="flex bg-gray-100 rounded-lg p-1 text-xs sm:text-sm">
                        <button onclick="updateChartPeriod('day')" id="btn-period-day" class="period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900">日</button>
                        <button onclick="updateChartPeriod('week')" id="btn-period-week" class="period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900">週</button>
                        <button onclick="updateChartPeriod('month')" id="btn-period-month" class="period-btn px-3 py-1.5 rounded-md transition-all bg-white shadow-sm text-blue-600 font-bold">月</button>
                        <button onclick="updateChartPeriod('year')" id="btn-period-year" class="period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900">年</button>
                    </div>
                </div>
                
                <!-- Chart.js Canvas -->
                <div class="relative h-72 w-full">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ==================== 頁面 2 & 3: 個別明細 (共用結構) ==================== -->
        <div id="view-detail" class="hidden space-y-6">
            
            <!-- 明細圖表區 (New!) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                 <h2 class="text-lg font-bold text-gray-800 flex items-center mb-4" id="detailChartTitle">
                    <i class="fa-solid fa-chart-area text-blue-500 mr-2"></i>距離與熱量分析
                </h2>
                <div class="relative h-64 w-full">
                    <canvas id="detailChart"></canvas>
                </div>
            </div>

            <!-- 明細表格 -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center" id="detailHeader">
                    <h3 class="font-bold text-gray-700">詳細紀錄列表</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期/時間</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">持續時間</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">距離 (km)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">熱量 (kcal)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">均速 (km/h)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 個別資料 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- 日詳細資料 Modal (New!) -->
    <div id="dayDetailModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeDayDetail()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto pointer-events-none">
            <div class="flex min-h-full items-center justify-center p-4 text-center">
                <div class="pointer-events-auto relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:w-full sm:max-w-lg w-full">
                    <div class="bg-blue-600 px-4 py-3 flex justify-between items-center text-white">
                        <h3 class="text-lg font-bold" id="dayDetailTitle">2023-10-27 紀錄</h3>
                        <button onclick="closeDayDetail()" class="text-blue-100 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div class="p-6">
                        <!-- 當日總計 -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gray-50 p-3 rounded-lg text-center border border-gray-200">
                                <span class="text-xs text-gray-500">總距離</span>
                                <div class="text-xl font-bold text-gray-800"><span id="dayTotalDist">0</span> <span class="text-xs font-normal">km</span></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center border border-gray-200">
                                <span class="text-xs text-gray-500">總熱量</span>
                                <div class="text-xl font-bold text-gray-800"><span id="dayTotalCal">0</span> <span class="text-xs font-normal">kcal</span></div>
                            </div>
                        </div>
                        
                        <!-- 當日列表 -->
                        <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">活動明細</h4>
                        <div id="dayDetailList" class="space-y-3 max-h-60 overflow-y-auto pr-1">
                            <!-- JS 填入 -->
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse">
                        <button type="button" onclick="closeDayDetail()" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto">關閉</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定 Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4">系統設定</h3>
                        <div class="space-y-4">
                            <!-- GAS URL -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">GAS 部署網址</label>
                                <input type="password" id="settingGasUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 sm:text-sm p-2 border">
                            </div>
                            <!-- Running Settings -->
                            <div class="bg-blue-50 p-3 rounded-md">
                                <label class="block text-sm font-medium text-blue-700">跑步試算表 ID</label>
                                <input type="text" id="settingRunId" class="mt-1 block w-full rounded-md border-gray-300 sm:text-sm p-2 border">
                                <label class="block text-xs text-gray-500 mt-1">工作表名稱</label>
                                <input type="text" id="settingRunSheetName" class="mt-1 block w-full rounded-md border-gray-300 text-xs p-2 border" value="運動紀錄 ">
                            </div>
                            <!-- Cycling Settings -->
                            <div class="bg-emerald-50 p-3 rounded-md">
                                <label class="block text-sm font-medium text-emerald-700">腳踏車試算表 ID</label>
                                <input type="text" id="settingBikeId" class="mt-1 block w-full rounded-md border-gray-300 sm:text-sm p-2 border">
                                <label class="block text-xs text-gray-500 mt-1">工作表名稱</label>
                                <input type="text" id="settingBikeSheetName" class="mt-1 block w-full rounded-md border-gray-300 text-xs p-2 border" value="騎乘紀錄  ">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 justify-between">
                        <button type="button" onclick="saveSettings()" class="w-full sm:w-auto inline-flex justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 ml-3">儲存</button>
                        <button type="button" onclick="closeSettings()" class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 說明 Modal -->
    <div id="helpModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-80" onclick="closeHelp()"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 relative z-10">
            <h2 class="text-xl font-bold mb-4">使用說明</h2>
            <p class="text-sm text-gray-600 mb-4">本系統整合了您的「跑步」與「腳踏車」試算表。月曆功能點選日期可查看當日明細。明細頁面包含距離與熱量分析圖表。</p>
            <div class="flex justify-end">
                <button onclick="closeHelp()" class="bg-gray-200 px-4 py-2 rounded text-sm hover:bg-gray-300">關閉</button>
            </div>
        </div>
    </div>

    <script>
        // === 全域變數 ===
        const LS_KEY = 'mySportTracker_config';
        let config = {};
        
        let dataCache = {
            running: [],
            cycling: []
        };
        
        let chartInstance = null; // 綜合圖表
        let detailChartInstance = null; // 明細頁圖表
        
        // 月曆狀態
        let currentCalendarDate = new Date();

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            if (config.gasUrl) {
                initDashboard(); 
            } else {
                openSettings();
            }
        });

        // === 核心資料邏輯 ===

        async function initDashboard() {
            const loader = document.getElementById('globalLoader');
            const dashboard = document.getElementById('view-dashboard');
            
            dashboard.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const [runData, bikeData] = await Promise.all([
                    fetchRawData(config.runId, config.runSheet, 'running'),
                    fetchRawData(config.bikeId, config.bikeSheet, 'cycling')
                ]);

                dataCache.running = runData;
                dataCache.cycling = bikeData;

                renderDashboard();
                renderCalendar(); // 初始化月曆
                
            } catch (error) {
                console.error("資料讀取失敗", error);
                document.getElementById('statusMsg').innerText = "資料讀取失敗，請檢查網路或設定";
                document.getElementById('statusMsg').classList.remove('hidden', 'bg-red-100', 'text-red-700');
            } finally {
                loader.classList.add('hidden');
                dashboard.classList.remove('hidden');
            }
        }

        async function fetchRawData(id, sheet, type) {
            if (!id) return [];
            const url = `${config.gasUrl}?action=read&spreadsheetId=${id}&sheetName=${encodeURIComponent(sheet)}&type=${type}`;
            const res = await fetch(url);
            const json = await res.json();
            if (json.status !== 'success') throw new Error(json.message);
            return json.data.map(item => ({ ...item, type: type }));
        }

        // === 畫面渲染 ===

        function switchMainTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                btn.classList.add('text-gray-600');
            });
            const activeBtn = document.getElementById(`nav-${tabName}`);
            activeBtn.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
            activeBtn.classList.remove('text-gray-600');

            const viewDash = document.getElementById('view-dashboard');
            const viewDetail = document.getElementById('view-detail');

            if (tabName === 'dashboard') {
                viewDash.classList.remove('hidden');
                viewDetail.classList.add('hidden');
                if(chartInstance) chartInstance.resize();
            } else {
                viewDash.classList.add('hidden');
                viewDetail.classList.remove('hidden');
                renderDetailTable(tabName);
                renderDetailChart(tabName); // 繪製明細圖表
            }
        }

        function renderDashboard() {
            const allData = [...dataCache.running, ...dataCache.cycling];
            
            let totalDist = 0;
            let totalCal = 0;
            let runDist = 0;
            let bikeDist = 0;

            allData.forEach(d => {
                const dist = parseFloat(d.distance) || 0;
                const cal = parseFloat(d.calories) || 0;
                totalDist += dist;
                totalCal += cal;
                if(d.type === 'running') runDist += dist;
                if(d.type === 'cycling') bikeDist += dist;
            });

            animateValue("dashTotalDistance", 0, totalDist, 1000, true);
            animateValue("dashTotalCalories", 0, totalCal, 1000);
            animateValue("dashTotalCount", 0, allData.length, 1000);
            document.getElementById('dashRunDist').innerText = runDist.toFixed(1) + " km";
            document.getElementById('dashBikeDist').innerText = bikeDist.toFixed(1) + " km";

            updateChartPeriod('month');
        }

        // === 月曆功能 (New) ===

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const calendarGrid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            
            title.innerText = `${year}年 ${month + 1}月`;
            calendarGrid.innerHTML = '';

            // 取得該月資料分佈
            const allData = [...dataCache.running, ...dataCache.cycling];
            const dataMap = {}; // Key: "YYYY-MM-DD", Value: Array of items
            
            allData.forEach(item => {
                const dateObj = parseDateSafely(item.date);
                if (dateObj) {
                    const key = `${dateObj.getFullYear()}-${dateObj.getMonth()}-${dateObj.getDate()}`; // 簡單Key
                    if (!dataMap[key]) dataMap[key] = [];
                    dataMap[key].push(item);
                }
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // 前面空白
            for (let i = 0; i < firstDay; i++) {
                calendarGrid.innerHTML += `<div class="calendar-day empty border-b border-r border-white"></div>`;
            }

            // 日期格
            for (let day = 1; day <= daysInMonth; day++) {
                const key = `${year}-${month}-${day}`;
                const items = dataMap[key] || [];
                let dotsHtml = '';
                
                // 檢查是否有跑步或單車
                let hasRun = items.some(i => i.type === 'running');
                let hasBike = items.some(i => i.type === 'cycling');
                
                if (hasRun) dotsHtml += `<span class="w-2 h-2 rounded-full bg-blue-500 mx-0.5"></span>`;
                if (hasBike) dotsHtml += `<span class="w-2 h-2 rounded-full bg-emerald-500 mx-0.5"></span>`;

                const bgClass = items.length > 0 ? "bg-white hover:bg-blue-50" : "bg-white text-gray-400";
                
                // 修正日期的資料屬性
                // 這裡必須正規化日期格式以供點擊使用 (YYYY/MM/DD)
                const dateStrForClick = `${year}/${(month+1).toString().padStart(2,'0')}/${day.toString().padStart(2,'0')}`;

                const cell = document.createElement('div');
                cell.className = `calendar-day p-2 border-b border-r border-gray-100 flex flex-col items-center justify-start ${bgClass}`;
                if (items.length > 0) {
                    cell.onclick = () => openDayDetail(dateStrForClick, items);
                }
                
                cell.innerHTML = `
                    <span class="text-sm font-medium ${items.length>0 ? 'text-gray-800' : ''}">${day}</span>
                    <div class="mt-2 flex">${dotsHtml}</div>
                `;
                calendarGrid.appendChild(cell);
            }
        }

        // 開啟單日詳細 Modal
        function openDayDetail(dateStr, items) {
            const modal = document.getElementById('dayDetailModal');
            const title = document.getElementById('dayDetailTitle');
            const list = document.getElementById('dayDetailList');
            const dDist = document.getElementById('dayTotalDist');
            const dCal = document.getElementById('dayTotalCal');

            title.innerText = `${dateStr} 運動紀錄`;
            list.innerHTML = '';
            
            let totalDist = 0;
            let totalCal = 0;

            items.forEach(item => {
                totalDist += parseFloat(item.distance) || 0;
                totalCal += parseFloat(item.calories) || 0;
                
                const typeInfo = item.type === 'running' 
                    ? { icon: 'fa-person-running', color: 'text-blue-600', bg: 'bg-blue-100', name: '跑步' }
                    : { icon: 'fa-bicycle', color: 'text-emerald-600', bg: 'bg-emerald-100', name: '單車' };

                const el = document.createElement('div');
                el.className = "flex items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm";
                el.innerHTML = `
                    <div class="p-2 rounded-full ${typeInfo.bg} ${typeInfo.color} mr-3">
                        <i class="fa-solid ${typeInfo.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-baseline">
                            <span class="font-bold text-gray-800">${typeInfo.name}</span>
                            <span class="text-xs text-gray-500">${item.date}</span>
                        </div>
                        <div class="mt-1 text-sm text-gray-600">
                            ${item.distance} km / ${item.calories} kcal
                        </div>
                        <div class="text-xs text-gray-400 mt-1 truncate w-full">${item.notes || ''}</div>
                    </div>
                `;
                list.appendChild(el);
            });

            dDist.innerText = totalDist.toFixed(2);
            dCal.innerText = Math.round(totalCal);

            modal.classList.remove('hidden');
        }

        function closeDayDetail() {
            document.getElementById('dayDetailModal').classList.add('hidden');
        }

        // === 明細圖表邏輯 (New) ===
        
        function renderDetailChart(type) {
            const ctx = document.getElementById('detailChart').getContext('2d');
            const title = document.getElementById('detailChartTitle');
            const data = [...dataCache[type]]; // Copy
            
            // UI 更新
            if (type === 'running') {
                title.innerHTML = '<i class="fa-solid fa-person-running text-blue-500 mr-2"></i>跑步 - 距離與熱量趨勢';
            } else {
                title.innerHTML = '<i class="fa-solid fa-bicycle text-emerald-500 mr-2"></i>單車 - 距離與熱量趨勢';
            }

            // 整理資料：按日期由舊到新排序
            data.sort((a, b) => {
                const da = parseDateSafely(a.date) || new Date(0);
                const db = parseDateSafely(b.date) || new Date(0);
                return da - db;
            });

            // 如果資料太多，取最近 30 筆
            const chartData = data.slice(-30);
            
            const labels = chartData.map(d => {
                const date = parseDateSafely(d.date);
                return date ? `${date.getMonth()+1}/${date.getDate()}` : d.date;
            });
            const distances = chartData.map(d => parseFloat(d.distance) || 0);
            const calories = chartData.map(d => parseFloat(d.calories) || 0);

            if (detailChartInstance) {
                detailChartInstance.destroy();
            }

            const mainColor = type === 'running' ? '59, 130, 246' : '16, 185, 129'; // Blue or Emerald

            detailChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '距離 (km)',
                            data: distances,
                            backgroundColor: `rgba(${mainColor}, 0.5)`,
                            borderColor: `rgba(${mainColor}, 1)`,
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: '熱量 (kcal)',
                            data: calories,
                            type: 'line',
                            borderColor: 'rgba(249, 115, 22, 1)', // Orange
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 3,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '距離 (km)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, // 右軸不畫網格線
                            title: { display: true, text: '熱量 (kcal)' }
                        }
                    }
                }
            });
        }

        function renderDetailTable(type) {
            const tbody = document.getElementById('detailTableBody');
            const header = document.querySelector('#detailHeader h3');
            const data = dataCache[type];
            
            header.innerText = type === 'running' ? '詳細紀錄列表' : '詳細紀錄列表';
            //header.className = type === 'running' ? 'font-bold text-blue-700' : 'font-bold text-emerald-700';

            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-gray-500">尚無資料</td></tr>`;
                return;
            }

            // 反轉顯示 (新到舊)
            [...data].reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${row.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.duration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-mono">${row.distance}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${row.calories}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${row.speed}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs" title="${row.notes}">${row.notes}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === 圖表與分析邏輯 (Dashboard) ===
        
        function parseDateSafely(dateStr) {
            if (!dateStr) return null;
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;
            
            let cleanStr = dateStr.replace(/[-.]/g, '/').replace(/年|月/g, '/').replace(/日/g, ' ');
            d = new Date(cleanStr);
            if (!isNaN(d.getTime())) return d;
            
            const match = cleanStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
            if (match) {
                return new Date(`${match[1]}/${match[2]}/${match[3]}`);
            }
            return null;
        }

        function updateChartPeriod(period) {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.className = 'period-btn px-3 py-1.5 rounded-md transition-all text-gray-600 hover:text-gray-900';
            });
            const activeBtn = document.getElementById(`btn-period-${period}`);
            activeBtn.className = 'period-btn px-3 py-1.5 rounded-md transition-all bg-white shadow-sm text-blue-600 font-bold';

            processChartData(period);
        }

        function processChartData(period) {
            const allData = [...dataCache.running, ...dataCache.cycling];
            const groupedMap = new Map();

            allData.forEach(item => {
                const dateObj = parseDateSafely(item.date);
                if (!dateObj) return;

                let sortKey = '';
                let displayLabel = '';
                const y = dateObj.getFullYear();
                const m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const d = dateObj.getDate().toString().padStart(2, '0');

                if (period === 'day') {
                    sortKey = `${y}-${m}-${d}`;
                    displayLabel = `${m}/${d}`;
                } else if (period === 'week') {
                    const day = dateObj.getDay() || 7;
                    const monday = new Date(dateObj);
                    monday.setHours(0,0,0,0);
                    monday.setDate(monday.getDate() - day + 1);
                    const my = monday.getFullYear();
                    const mm = (monday.getMonth() + 1).toString().padStart(2, '0');
                    const md = monday.getDate().toString().padStart(2, '0');
                    sortKey = `${my}-${mm}-${md}`;
                    displayLabel = `${mm}/${md} 週`;
                } else if (period === 'month') {
                    sortKey = `${y}-${m}`;
                    displayLabel = `${y}-${m}`;
                } else if (period === 'year') {
                    sortKey = `${y}`;
                    displayLabel = `${y}`;
                }

                if (!groupedMap.has(sortKey)) {
                    groupedMap.set(sortKey, { displayLabel: displayLabel, running: 0, cycling: 0 });
                }
                
                const entry = groupedMap.get(sortKey);
                const dist = parseFloat(item.distance) || 0;
                
                if (item.type === 'running') entry.running += dist;
                else entry.cycling += dist;
            });

            const sortedEntries = Array.from(groupedMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            const displayLimit = period === 'day' ? 30 : (period === 'week' ? 24 : 100);
            const finalData = sortedEntries.slice(-displayLimit);

            const labels = finalData.map(e => e[1].displayLabel);
            const dataRun = finalData.map(e => e[1].running);
            const dataBike = finalData.map(e => e[1].cycling);

            drawChart(labels, dataRun, dataBike);
        }

        function drawChart(labels, dataRun, dataBike) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '跑步 (km)',
                            data: dataRun,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', 
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: '單車 (km)',
                            data: dataBike,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)', 
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        function animateValue(id, start, end, duration, isFloat = false) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = progress * (end - start) + start;
                obj.innerHTML = isFloat ? val.toFixed(1) : Math.floor(val);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function loadSettings() {
            const saved = localStorage.getItem(LS_KEY);
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('settingGasUrl').value = config.gasUrl || '';
                document.getElementById('settingRunId').value = config.runId || '';
                document.getElementById('settingRunSheetName').value = config.runSheet || '運動紀錄 ';
                document.getElementById('settingBikeId').value = config.bikeId || '';
                document.getElementById('settingBikeSheetName').value = config.bikeSheet || '騎乘紀錄  ';
            }
        }

        function saveSettings() {
            config.gasUrl = document.getElementById('settingGasUrl').value.trim();
            config.runId = document.getElementById('settingRunId').value.trim();
            config.runSheet = document.getElementById('settingRunSheetName').value;
            config.bikeId = document.getElementById('settingBikeId').value.trim();
            config.bikeSheet = document.getElementById('settingBikeSheetName').value;
            localStorage.setItem(LS_KEY, JSON.stringify(config));
            closeSettings();
            initDashboard(); 
        }

        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
        function openHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }
    </script>
</body>
</html>
